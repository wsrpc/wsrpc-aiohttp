/*
 Copyright 2009-2017 Kris Kowal under the terms of the MIT
 license found at https://github.com/kriskowal/q/blob/v1/LICENSE

 With parts by Tyler Close
 Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 at http://www.opensource.org/licenses/mit-license.html
 Forked at ref_send.js version: 2009-05-11

 With parts by Mark Miller
 Copyright (C) 2011 Google Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(d){var k=0;return function(){return k<d.length?{done:!1,value:d[k++]}:{done:!0}}};$jscomp.arrayIterator=function(d){return{next:$jscomp.arrayIteratorImpl(d)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,k,m){d!=Array.prototype&&d!=Object.prototype&&(d[k]=m.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(d,k){this.$jscomp$symbol$id_=d;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:k})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function d(m){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(m||"")+"_"+k++,m)}var k=0;return d}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.asyncIterator;d||(d=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};
$jscomp.iteratorFromArray=function(d,k){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var m=0,p={next:function(){if(m<d.length){var b=m++;return{value:k(b,d[b]),done:!1}}p.next=function(){return{done:!0,value:void 0}};return p.next()}};p[Symbol.iterator]=function(){return p};return p};
$jscomp.polyfill=function(d,k,m,p){if(k){m=$jscomp.global;d=d.split(".");for(p=0;p<d.length-1;p++){var b=d[p];b in m||(m[b]={});m=m[b]}d=d[d.length-1];p=m[d];k=k(p);k!=p&&null!=k&&$jscomp.defineProperty(m,d,{configurable:!0,writable:!0,value:k})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6","es3");
(function(d){if("function"===typeof bootstrap)bootstrap("promise",d);else if("object"===typeof exports&&"object"===typeof module)module.exports=d();else if("function"===typeof define&&define.amd)define(d);else if("undefined"!==typeof ses)ses.ok()&&(ses.makeQ=d);else if("undefined"!==typeof window||"undefined"!==typeof self){var k="undefined"!==typeof window?window:self,m=k.Q;k.Q=d();k.Q.noConflict=function(){k.Q=m;return this}}else throw Error("This environment was not anticipated by Q. Please file a bug.");
})(function(){function d(a){return function(){return aa.apply(a,arguments)}}function k(a,c){if(A&&c.stack&&"object"===typeof a&&null!==a&&a.stack){for(var b=[];c;c=c.source)c.stack&&(!a.__minimumStackCounter__||a.__minimumStackCounter__>c.stackCounter)&&(N(a,"__minimumStackCounter__",{value:c.stackCounter,configurable:!0}),b.unshift(c.stack));b.unshift(a.stack);b=b.join("\nFrom previous event:\n").split("\n");c=[];for(var e=0;e<b.length;++e){var d=b[e],f;if(f=m(d)){var B=f[1];f=f[0]===P&&B>=ba&&B<=
ca}else f=!1;f||(f=d,f=-1!==f.indexOf("(module.js:")||-1!==f.indexOf("(node.js:"));f||!d||c.push(d)}b=c.join("\n");N(a,"stack",{value:b,configurable:!0})}}function m(a){var c=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(c||(c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a)))return[c[1],Number(c[2])];if(a=/.*@(.+):(\d+)$/.exec(a))return[a[1],Number(a[2])]}function p(){if(A)try{throw Error();}catch(c){var a=c.stack.split("\n");a=0<a[0].indexOf("@")?a[1]:a[2];if(a=m(a))return P=a[0],a[1]}}function b(a){return a instanceof
f?a:R(a)?da(a):t(a)}function e(){function a(a){d=a;b.longStackSupport&&A&&(v.source=a);C(c,function(c,h){b.nextTick(function(){a.promiseDispatch.apply(a,h)})},void 0);h=c=void 0}var c=[],h=[],d,g=I(e.prototype),v=I(f.prototype);v.promiseDispatch=function(a,e,f){var O=n(arguments);c?(c.push(O),"when"===e&&f[1]&&h.push(f[1])):b.nextTick(function(){d.promiseDispatch.apply(d,O)})};v.valueOf=function(){if(c)return v;var a=q(d);w(a)&&(d=a);return a};v.inspect=function(){return d?d.inspect():{state:"pending"}};
if(b.longStackSupport&&A)try{throw Error();}catch(B){v.stack=B.stack.substring(B.stack.indexOf("\n")+1),v.stackCounter=ea++}g.promise=v;g.resolve=function(c){d||a(b(c))};g.fulfill=function(c){d||a(t(c))};g.reject=function(c){d||a(u(c))};g.notify=function(a){d||C(h,function(c,h){b.nextTick(function(){h(a)})},void 0)};return g}function l(a){if("function"!==typeof a)throw new TypeError("resolver must be a function.");var c=e();try{a(c.resolve,c.reject,c.notify)}catch(h){c.reject(h)}return c.promise}
function x(a){return l(function(c,h){for(var e=0,d=a.length;e<d;e++)b(a[e]).then(c,h)})}function f(a,c,b){void 0===c&&(c=function(a){return u(Error("Promise does not support operation: "+a))});void 0===b&&(b=function(){return{state:"unknown"}});var h=I(f.prototype);h.promiseDispatch=function(b,e,d){try{var f=a[e]?a[e].apply(h,d):c.call(h,e,d)}catch(E){f=u(E)}b&&b(f)};if(h.inspect=b){var e=b();"rejected"===e.state&&(h.exception=e.reason);h.valueOf=function(){var a=b();return"pending"===a.state||"rejected"===
a.state?h:a.value}}return h}function g(a,c,h,e){return b(a).then(c,h,e)}function q(a){if(w(a)){var c=a.inspect();if("fulfilled"===c.state)return c.value}return a}function w(a){return a instanceof f}function R(a){return a===Object(a)&&"function"===typeof a.then}function J(){y.length=0;F.length=0;G||(G=!0)}function r(a,c){G&&("object"===typeof process&&"function"===typeof process.emit&&b.nextTick.runAfter(function(){-1!==K(F,a)&&(process.emit("unhandledRejection",c,a),L.push(a))}),F.push(a),c&&"undefined"!==
typeof c.stack?y.push(c.stack):y.push("(no stack) "+c))}function fa(a){if(G){var c=K(F,a);-1!==c&&("object"===typeof process&&"function"===typeof process.emit&&b.nextTick.runAfter(function(){var b=K(L,a);-1!==b&&(process.emit("rejectionHandled",y[c],a),L.splice(b,1))}),F.splice(c,1),y.splice(c,1))}}function u(a){var c=f({when:function(c){c&&fa(this);return c?c(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});r(c,a);return c}function t(a){return f({when:function(){return a},
get:function(c){return a[c]},set:function(c,b){a[c]=b},"delete":function(c){delete a[c]},post:function(c,b){return null===c||void 0===c?a.apply(void 0,b):a[c].apply(a,b)},apply:function(c,b){return a.apply(c,b)},keys:function(){return ha(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function da(a){var c=e();b.nextTick(function(){try{a.then(c.resolve,c.reject,c.notify)}catch(h){c.reject(h)}});return c.promise}function S(a,c,h){return b(a).spread(c,h)}function T(a,c,h){return b(a).dispatch(c,
h)}function z(a){return g(a,function(a){var c=0,b=e();C(a,function(h,e,d){var f;w(e)&&"fulfilled"===(f=e.inspect()).state?a[d]=f.value:(++c,g(e,function(h){a[d]=h;0===--c&&b.resolve(a)},b.reject,function(a){b.notify({index:d,value:a})}))},void 0);0===c&&b.resolve(a);return b.promise})}function U(a){if(0===a.length)return b.resolve();var c=b.defer(),h=0;C(a,function(b,e,d){b=a[d];h++;g(b,function(a){c.resolve(a)},function(a){h--;0===h&&(a=a||Error(""+a),a.message="Q can't get fulfillment value from any promise, all promises were rejected. Last error message: "+
a.message,c.reject(a))},function(a){c.notify({index:d,value:a})})},void 0);return c.promise}function V(a){return g(a,function(a){a=M(a,b);return g(z(M(a,function(a){return g(a,W,W)})),function(){return a})})}var A=!1;try{throw Error();}catch(a){A=!!a.stack}var ba=p(),P,W=function(){},H=function(){function a(){for(var a,e;b.next;){b=b.next;a=b.task;b.task=void 0;if(e=b.domain)b.domain=void 0,e.enter();c(a,e)}for(;r.length;)a=r.pop(),c(a);d=!1}function c(c,b){try{c()}catch(Y){if(g)throw b&&b.exit(),
setTimeout(a,0),b&&b.enter(),Y;setTimeout(function(){throw Y;},0)}b&&b.exit()}var b={task:void 0,next:null},e=b,d=!1,f=void 0,g=!1,r=[];H=function(a){e=e.next={task:a,domain:g&&process.domain,next:null};d||(d=!0,f())};if("object"===typeof process&&"[object process]"===process.toString()&&process.nextTick)g=!0,f=function(){process.nextTick(a)};else if("function"===typeof setImmediate)f="undefined"!==typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!==typeof MessageChannel){var q=
new MessageChannel;q.port1.onmessage=function(){f=k;q.port1.onmessage=a;a()};var k=function(){q.port2.postMessage(0)};f=function(){setTimeout(a,0);k()}}else f=function(){setTimeout(a,0)};H.runAfter=function(a){r.push(a);d||(d=!0,f())};return H}(),aa=Function.call,n=d(Array.prototype.slice),C=d(Array.prototype.reduce||function(a,c){var b=0,e=this.length;if(1===arguments.length){do{if(b in this){c=this[b++];break}if(++b>=e)throw new TypeError;}while(1)}for(;b<e;b++)b in this&&(c=a(c,this[b],b));return c}),
K=d(Array.prototype.indexOf||function(a){for(var c=0;c<this.length;c++)if(this[c]===a)return c;return-1}),M=d(Array.prototype.map||function(a,c){var b=this,e=[];C(b,function(h,d,f){e.push(a.call(c,d,f,b))},void 0);return e}),I=Object.create||function(a){function c(){}c.prototype=a;return new c},N=Object.defineProperty||function(a,c,b){a[c]=b.value;return a},ia=d(Object.prototype.hasOwnProperty),ha=Object.keys||function(a){var c=[],b;for(b in a)ia(a,b)&&c.push(b);return c},ja=d(Object.prototype.toString);
var Z="undefined"!==typeof ReturnValue?ReturnValue:function(a){this.value=a};b.resolve=b;b.nextTick=H;b.longStackSupport=!1;var ea=1;"object"===typeof process&&process&&process.env&&process.env.Q_DEBUG&&(b.longStackSupport=!0);b.defer=e;e.prototype.makeNodeResolver=function(){var a=this;return function(c,b){c?a.reject(c):2<arguments.length?a.resolve(n(arguments,1)):a.resolve(b)}};b.Promise=l;b.promise=l;l.race=x;l.all=z;l.reject=u;l.resolve=b;b.passByCopy=function(a){return a};f.prototype.passByCopy=
function(){return this};b.join=function(a,c){return b(a).join(c)};f.prototype.join=function(a){return b([this,a]).spread(function(a,b){if(a===b)return a;throw Error("Q can't join: not the same: "+a+" "+b);})};b.race=x;f.prototype.race=function(){return this.then(b.race)};b.makePromise=f;f.prototype.toString=function(){return"[object Promise]"};f.prototype.then=function(a,c,d){function h(c){try{return"function"===typeof a?a(c):c}catch(E){return u(E)}}function f(a){if("function"===typeof c){k(a,g);
try{return c(a)}catch(E){return u(E)}}return u(a)}var g=this,r=e(),q=!1;b.nextTick(function(){g.promiseDispatch(function(a){q||(q=!0,r.resolve(h(a)))},"when",[function(a){q||(q=!0,r.resolve(f(a)))}])});g.promiseDispatch(void 0,"when",[void 0,function(a){var c=!1;try{var e="function"===typeof d?d(a):a}catch(X){if(c=!0,b.onerror)b.onerror(X);else throw X;}c||r.notify(e)}]);return r.promise};b.tap=function(a,c){return b(a).tap(c)};f.prototype.tap=function(a){a=b(a);return this.then(function(c){return a.fcall(c).thenResolve(c)})};
b.when=g;f.prototype.thenResolve=function(a){return this.then(function(){return a})};b.thenResolve=function(a,c){return b(a).thenResolve(c)};f.prototype.thenReject=function(a){return this.then(function(){throw a;})};b.thenReject=function(a,c){return b(a).thenReject(c)};b.nearer=q;b.isPromise=w;b.isPromiseAlike=R;b.isPending=function(a){return w(a)&&"pending"===a.inspect().state};f.prototype.isPending=function(){return"pending"===this.inspect().state};b.isFulfilled=function(a){return!w(a)||"fulfilled"===
a.inspect().state};f.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};b.isRejected=function(a){return w(a)&&"rejected"===a.inspect().state};f.prototype.isRejected=function(){return"rejected"===this.inspect().state};var y=[],F=[],L=[],G=!0;b.resetUnhandledRejections=J;b.getUnhandledReasons=function(){return y.slice()};b.stopUnhandledRejectionTracking=function(){J();G=!1};J();b.reject=u;b.fulfill=t;b.master=function(a){return f({isDef:function(){}},function(c,b){return T(a,
c,b)},function(){return b(a).inspect()})};b.spread=S;f.prototype.spread=function(a,c){return this.all().then(function(c){return a.apply(void 0,c)},c)};b.async=function(a){return function(){function c(a,c){if("undefined"===typeof StopIteration){try{var h=e[a](c)}catch(D){return u(D)}return h.done?b(h.value):g(h.value,d,f)}try{h=e[a](c)}catch(D){return a=D,"[object StopIteration]"===ja(a)||a instanceof Z?b(D.value):u(D)}return g(h,d,f)}var e=a.apply(this,arguments),d=c.bind(c,"next"),f=c.bind(c,"throw");
return d()}};b.spawn=function(a){b.done(b.async(a)())};b["return"]=function(a){throw new Z(a);};b.promised=function(a){return function(){return S([this,z(arguments)],function(c,b){return a.apply(c,b)})}};b.dispatch=T;f.prototype.dispatch=function(a,c){var d=this,f=e();b.nextTick(function(){d.promiseDispatch(f.resolve,a,c)});return f.promise};b.get=function(a,c){return b(a).dispatch("get",[c])};f.prototype.get=function(a){return this.dispatch("get",[a])};b.set=function(a,c,e){return b(a).dispatch("set",
[c,e])};f.prototype.set=function(a,c){return this.dispatch("set",[a,c])};b.del=b["delete"]=function(a,c){return b(a).dispatch("delete",[c])};f.prototype.del=f.prototype["delete"]=function(a){return this.dispatch("delete",[a])};b.mapply=b.post=function(a,c,e){return b(a).dispatch("post",[c,e])};f.prototype.mapply=f.prototype.post=function(a,c){return this.dispatch("post",[a,c])};b.send=b.mcall=b.invoke=function(a,c){return b(a).dispatch("post",[c,n(arguments,2)])};f.prototype.send=f.prototype.mcall=
f.prototype.invoke=function(a){return this.dispatch("post",[a,n(arguments,1)])};b.fapply=function(a,c){return b(a).dispatch("apply",[void 0,c])};f.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])};b["try"]=b.fcall=function(a){return b(a).dispatch("apply",[void 0,n(arguments,1)])};f.prototype.fcall=function(){return this.dispatch("apply",[void 0,n(arguments)])};b.fbind=function(a){var c=b(a),e=n(arguments,1);return function(){return c.dispatch("apply",[this,e.concat(n(arguments))])}};
f.prototype.fbind=function(){var a=this,c=n(arguments);return function(){return a.dispatch("apply",[this,c.concat(n(arguments))])}};b.keys=function(a){return b(a).dispatch("keys",[])};f.prototype.keys=function(){return this.dispatch("keys",[])};b.all=z;f.prototype.all=function(){return z(this)};b.any=U;f.prototype.any=function(){return U(this)};b.allResolved=function(a,c,b){return function(){"undefined"!==typeof console&&"function"===typeof console.warn&&console.warn(c+" is deprecated, use "+b+" instead.",
Error("").stack);return a.apply(a,arguments)}}(V,"allResolved","allSettled");f.prototype.allResolved=function(){return V(this)};b.allSettled=function(a){return b(a).allSettled()};f.prototype.allSettled=function(){return this.then(function(a){return z(M(a,function(a){function c(){return a.inspect()}a=b(a);return a.then(c,c)}))})};b.fail=b["catch"]=function(a,c){return b(a).then(void 0,c)};f.prototype.fail=f.prototype["catch"]=function(a){return this.then(void 0,a)};b.progress=function(a,c){return b(a).then(void 0,
void 0,c)};f.prototype.progress=function(a){return this.then(void 0,void 0,a)};b.fin=b["finally"]=function(a,c){return b(a)["finally"](c)};f.prototype.fin=f.prototype["finally"]=function(a){if(!a||"function"!==typeof a.apply)throw Error("Q can't apply finally callback");a=b(a);return this.then(function(c){return a.fcall().then(function(){return c})},function(c){return a.fcall().then(function(){throw c;})})};b.done=function(a,c,e,d){return b(a).done(c,e,d)};f.prototype.done=function(a,c,e){var d=function(a){b.nextTick(function(){k(a,
f);if(b.onerror)b.onerror(a);else throw a;})},f=a||c||e?this.then(a,c,e):this;"object"===typeof process&&process&&process.domain&&(d=process.domain.bind(d));f.then(void 0,d)};b.timeout=function(a,c,e){return b(a).timeout(c,e)};f.prototype.timeout=function(a,c){var b=e(),d=setTimeout(function(){c&&"string"!==typeof c||(c=Error(c||"Timed out after "+a+" ms"),c.code="ETIMEDOUT");b.reject(c)},a);this.then(function(a){clearTimeout(d);b.resolve(a)},function(a){clearTimeout(d);b.reject(a)},b.notify);return b.promise};
b.delay=function(a,c){void 0===c&&(c=a,a=void 0);return b(a).delay(c)};f.prototype.delay=function(a){return this.then(function(c){var b=e();setTimeout(function(){b.resolve(c)},a);return b.promise})};b.nfapply=function(a,c){return b(a).nfapply(c)};f.prototype.nfapply=function(a){var c=e();a=n(a);a.push(c.makeNodeResolver());this.fapply(a).fail(c.reject);return c.promise};b.nfcall=function(a){var c=n(arguments,1);return b(a).nfapply(c)};f.prototype.nfcall=function(){var a=n(arguments),c=e();a.push(c.makeNodeResolver());
this.fapply(a).fail(c.reject);return c.promise};b.nfbind=b.denodeify=function(a){if(void 0===a)throw Error("Q can't wrap an undefined function");var c=n(arguments,1);return function(){var d=c.concat(n(arguments)),f=e();d.push(f.makeNodeResolver());b(a).fapply(d).fail(f.reject);return f.promise}};f.prototype.nfbind=f.prototype.denodeify=function(){var a=n(arguments);a.unshift(this);return b.denodeify.apply(void 0,a)};b.nbind=function(a,c){var d=n(arguments,2);return function(){var f=d.concat(n(arguments)),
g=e();f.push(g.makeNodeResolver());b(function(){return a.apply(c,arguments)}).fapply(f).fail(g.reject);return g.promise}};f.prototype.nbind=function(){var a=n(arguments,0);a.unshift(this);return b.nbind.apply(void 0,a)};b.nmapply=b.npost=function(a,c,e){return b(a).npost(c,e)};f.prototype.nmapply=f.prototype.npost=function(a,c){c=n(c||[]);var b=e();c.push(b.makeNodeResolver());this.dispatch("post",[a,c]).fail(b.reject);return b.promise};b.nsend=b.nmcall=b.ninvoke=function(a,c){var d=n(arguments,2),
f=e();d.push(f.makeNodeResolver());b(a).dispatch("post",[c,d]).fail(f.reject);return f.promise};f.prototype.nsend=f.prototype.nmcall=f.prototype.ninvoke=function(a){var c=n(arguments,1),b=e();c.push(b.makeNodeResolver());this.dispatch("post",[a,c]).fail(b.reject);return b.promise};b.nodeify=function(a,c){return b(a).nodeify(c)};f.prototype.nodeify=function(a){if(a)this.then(function(c){b.nextTick(function(){a(null,c)})},function(c){b.nextTick(function(){a(c)})});else return this};b.noConflict=function(){throw Error("Q.noConflict only works when Q is used as a global");
};var ca=p();return b});(function(d){d.WSRPC=function(k,m){function p(d){setTimeout(function(){try{e.socket=b(),e.id=1}catch(q){d("onerror",q),delete e.socket,l(q)}},m||1E3)}function b(b){function d(b,d){for(;0<e.oneTimeEventStore[b].length;){var f=e.oneTimeEventStore[b].shift();f.hasOwnProperty("resolve")&&f.promise.isPending()&&f.resolve()}for(var g in e.eventStore[b]){f=e.eventStore[b][g];try{f(d)}catch(t){t.hasOwnProperty("stack")?l(t.stack):l("Event function "+f+" raised unknown error: "+t)}}}var f=new WebSocket(k),
g=function(){for(e.connectionNumber++;0<e.callQueue.length;){var b=e.callQueue.shift(),d=e.store[b.serial];delete e.store[b.serial];d&&d.promise.isPending()&&d.reject("WebSocket error occurred")}for(var f in e.store)(d=e.store[f])&&d.promise.isPending()&&d.reject("WebSocket error occurred")};f.onclose=function(f){l("WSRPC: ONCLOSE CALLED (STATE: "+e.public.state()+")");x(f);for(var r in e.store)e.store[r].hasOwnProperty("reject")&&e.store[r].promise.isPending()&&e.store[r].reject("Connection closed");
g();d("onclose",b);d("onchange",b);p(d)};f.onerror=function(b){l("WSRPC: ONERROR CALLED (STATE: "+e.public.state()+")");x(b);g();d("onerror",b);d("onchange",b);l(["WebSocket has been closed by error: ",b])};f.onopen=function(b){l("WSRPC: ONOPEN CALLED (STATE: "+e.public.state()+")");for(x(b);0<e.callQueue.length;)e.socket.send(JSON.stringify(e.callQueue.shift(),0,1));d("onconnect",b);d("onchange",b)};f.onmessage=function(b){l("WSRPC: ONMESSAGE CALLED ("+e.public.state()+")");x(b);var d=null;if("message"==
b.type)try{if(d=JSON.parse(b.data),l(d.data),d.hasOwnProperty("method")){if(!e.routes.hasOwnProperty(d.method))throw Error("Route not found");var f=e.connectionNumber;Q(e.routes[d.method](d.params)).then(function(b){f==e.connectionNumber&&e.socket.send(JSON.stringify({id:d.id,result:b,error:null}))}).done()}else if(d.hasOwnProperty("error")&&null===d.error){if(!e.store.hasOwnProperty(d.id))return l("Unknown callback");var g=e.store[d.id];if("undefined"===typeof g)return l("Confirmation without handler");
delete e.store[d.id];l("REJECTING: "+d.error);g.reject(d.error)}else{g=e.store[d.id];if("undefined"===typeof g)return l("Confirmation without handler");delete e.store[d.id];return d.result?g.resolve(d.result):g.reject(d.error)}}catch(t){e.socket.send(JSON.stringify({error:t.message,result:null,id:d?d.id:null})),l(t.stack)}};return f}var e=this;e.id=1;e.eventId=0;e.socketStarted=!1;e.eventStore={onconnect:{},onerror:{},onclose:{},onchange:{}};e.connectionNumber=0;e.oneTimeEventStore={onconnect:[],
onerror:[],onclose:[],onchange:[]};e.callQueue=[];var l=function(b){d.WSRPC.DEBUG&&("group"in console&&"groupEnd"in console?(console.group("WSRPC.DEBUG"),console.debug(b),console.groupEnd()):console.debug(b))},x=function(b){d.WSRPC.TRACE&&("group"in console&&"groupEnd"in console&&"dir"in console?(console.group("WSRPC.TRACE"),"data"in b?console.dir(JSON.parse(b.data)):console.dir(b),console.groupEnd()):"data"in b?console.log("OBJECT DUMP: "+b.data):console.log("OBJECT DUMP: "+b))},f={0:"CONNECTING",
1:"OPEN",2:"CLOSING",3:"CLOSED"};e.routes={};e.store={};e.public={call:function(b,d,f){e.id+=2;var g=Q.defer();b={id:e.id,method:b,params:d};d=e.public.state();"OPEN"===d?(e.store[e.id]=g,e.socket.send(JSON.stringify(b))):"CONNECTING"===d?(l("SOCKET IS: "+d),e.store[e.id]=g,e.callQueue.push(b)):(l("SOCKET IS: "+d),f&&f.noWait?g.reject("Socket is: "+d):(e.store[e.id]=g,e.callQueue.push(b)));return g.promise},init:function(){l("Websocket initializing..")},addRoute:function(b,d){e.routes[b]=d},addEventListener:function(b,
d,f){void 0===f&&(f=!1);var g=e.eventId++;e.eventStore[b][g]=d;return f?g:d},onEvent:function(b){var d=Q.defer();e.oneTimeEventStore[b].push(d);return d.promise},removeEventListener:function(b,d){return e.eventStore[b].hasOwnProperty(d)?(delete e.eventStore[b][d],!0):!1},deleteRoute:function(b){return delete e.routes[b]},destroy:function(){function b(){}e.socket.onclose=b;e.socket.onerror=b;return e.socket.close()},state:function(){return e.socketStarted&&e.socket?f[e.socket.readyState]:f[3]},connect:function(){e.socketStarted=
!0;e.socket=b()}};e.public.addRoute("log",function(b){console.info("Websocket sent: "+b)});e.public.addRoute("ping",function(b){return b});return e.public};d.WSRPC.DEBUG=!1;d.WSRPC.TRACE=!1})(this);
